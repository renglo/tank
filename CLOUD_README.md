# CLOUD SETUP

The goal of this document is to show how to setup the cloud to host TankTower applications


Step 1: Super Dev Permissions

Create a user in IAM that uses an AWS managed policy called "AdministratorAccess-Amplify"
- This is a very powerful user that allows among other things to:
    + Deploy new Zappa environments to the cloud
    + Connect to AWS resources during development (You can run a full cloud application from your laptop)


Step 2: Add TankSpecific permissions 


"cluster_name" represents a stand-alone set of cloud services that can host multiple Zappa Environments, each one of them logically separated. 
TankTower was designed to be distributed, the ideas is that each cluster should host just a handful of Zappa environments to use a minimal amount of resources to stay within the free range of cloud services. 

While you can overload a cluster and turn it into a centralized hub, it is better to distribute the computing and cost across the companies that are using it (similar to the principle of WordPress being a common repository but being installed everywhere instead of it being a centralized SaaS).


Create this custom inline policy and add it to the user you created in step 1


{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "dynamodb:GetItem",
                "dynamodb:Query",
                "dynamodb:PutItem",
                "dynamodb:UpdateItem",
                "dynamodb:DeleteItem"
            ],
            "Resource": [
                "arn:aws:dynamodb:<aws_region>:<aws_account_number>:table/blueprints",
                "arn:aws:dynamodb:<aws_region>:<aws_account_number>:table/<environment_name>_data",
                "arn:aws:dynamodb:<aws_region>:<aws_account_number>:table/<environment_name>_entities",
                "arn:aws:dynamodb:<aws_region>:<aws_account_number>:table/<environment_name>_rel",
                "arn:aws:dynamodb:<aws_region>:<aws_account_number>:table/<environment_name>_data/index/path_index"
            ]
        },
        {
            "Effect": "Allow",
            "Action": "ses:SendEmail",
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": "execute-api:Invoke",
            "Resource": "arn:aws:execute-api:us-east-1:<aws_account_number>:gs338uqho1/*/*/"
        }
    ]
}



Step 3: Create the tables that are listed in the Resource array in the policy from step 2. 


Step 4: Create the Zappa/TankTower Policy that the Application will use when loaded to the Lambda

- The policy name should be:  tanktower_<environment_name>
- It is a combination between the standard zappa-permissions policy that is automatically generated by zappa on deployment and 
the inline policy created in step 2. 
- It uses minimum required permissions


{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "lambda:InvokeFunction"
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "apigateway:POST",
                "apigateway:GET",
                "apigateway:PUT",
                "apigateway:DELETE"
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "s3:PutObject",
                "s3:GetObject",
                "s3:DeleteObject"
            ],
            "Resource": "arn:aws:s3:::<s3_bucket_name>/*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
            ],
            "Resource": "arn:aws:logs:*:*:*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "dynamodb:GetItem",
                "dynamodb:Query",
                "dynamodb:PutItem",
                "dynamodb:UpdateItem",
                "dynamodb:DeleteItem"
            ],
            "Resource": [
                "arn:aws:dynamodb:<aws_region>:<aws_account_number>:table/blueprints",
                "arn:aws:dynamodb:<aws_region>:<aws_account_number>:table/<environment_name>_data",
                "arn:aws:dynamodb:<aws_region>:<aws_account_number>:table/<environment_name>_entities",
                "arn:aws:dynamodb:<aws_region>:<aws_account_number>:table/<environment_name>_rel",
                "arn:aws:dynamodb:<aws_region>:<aws_account_number>:table/<environment_name>_data/index/path_index"
            ]
        },
        {
            "Effect": "Allow",
            "Action": "ses:SendEmail",
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "cognito-idp:ListUsers",
                "cognito-idp:AdminCreateUser",
                "cognito-idp:AdminSetUserPassword",
                "cognito-idp:AdminInitiateAuth",
                "cognito-idp:RespondToAuthChallenge"
            ],
            "Resource": "arn:aws:cognito-idp:us-east-1:<aws_account_id>:userpool/<aws_region>_<user_pool_id>"
        }
    ]
}


Step 5: Create a role that uses your newly created policy

- Go to IAM > Roles > Create Role
- Select "AWS Service"
- Select Service: Lambda
- Find the policy you just created in the search:  tanktower_<environment_name>
- Name your new role tanktower_role_<environment_name>
- Click on "Create Role"

It will show a success message
- Look for the new Role , and copy the ARN
arn:aws:iam::<aws_account_number>:role/tanktower_role_<environment_name>



Step 5b: Adjust the Trust Policy to include events
- Go to the IAM console, find the role and look for the Trust relationships tab
- Edit the policy to look like this:

{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "",
            "Effect": "Allow",
            "Principal": {
                "Service": [
                    "apigateway.amazonaws.com",
                    "events.amazonaws.com",
                    "lambda.amazonaws.com"
                ]
            },
            "Action": "sts:AssumeRole"
        }
    ]
}


Step5c: Create a revoke sessions policy the same way as last step 

{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Deny",
            "Action": [
                "*"
            ],
            "Resource": [
                "*"
            ],
            "Condition": {
                "DateLessThan": {
                    "aws:TokenIssueTime": "[policy creation time]"
                }
            }
        }
    ]
}


Step 6: Assign role to your Flask Application

-  Put the role IAM in zappa_settings.json




Step 7: Application Email

- In order for the App to send emails to users (e.g.invitation emails) you need to create an identity in SES
- An identity is the email that will show as the "from" in the email metadata. Usually it looks like no-reply@<your_domain>.com

- Please notice that is you don't want to send emails out, you can just have your users to generate an account
in the environment directly. Those emails are validated directly by AWS Cognito so you don't need to put them in the
SES identity list. 


Step 8: Default Blueprints

- There is a list of Blueprints that TankTower require to operate. 
- A very important blueprint is sys/entities that help define portfolios, orgs, teams and users
- 