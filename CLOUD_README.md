# CLOUD SETUP

This is the second part of the installation process which involves creating all the cloud dependencies and deploying the app to a public endpoint. 


### Step 1: Create the Installer user

Create a user called 'tt-installer' in IAM that uses an AWS managed policy called "AdministratorAccess"
- This is a very powerful user that allows among other things to:
    + Deploy new Zappa environments to the cloud
    + Connect to AWS resources during development (You can run a full cloud application from your laptop)


### Step 1b: (ALTERNATIVE STEP) CREATING INSTALLER USER IN THIRD PARTY AWS ACCOUNT

Ask the third party Admin to 
1. Create a user (tt_dev) 
2. Create a user group (tt_dev_group)
3. Assign the AWS managed role "AdministratorAccess" to the user group
4. Assign the user to that user group
    In order to do this, they'll have to create a group. The group will have assigned the role, the user will be assinged to that group.
5. Create the Acess Key ID and Secret Access Key that will allow the app to gain access (select : Local Code)


### Step 2: Create AWS Profile

 You can have multiple sets. Each one of them is called a Profile. 

 Install awscli 
 `brew install awscli`

 Verify installation
 `aws --version`

 Run configuration script
 `aws configure`

 You'll get a prompt like the following. Enter the access key, secret key and output. Leave output as None.

AWS Access Key ID [None]: YOUR_ACCESS_KEY
AWS Secret Access Key [None]: YOUR_SECRET_KEY
Default region name [None]: us-east-1  # (or your preferred region)
Default output format [None]: json


The credentials for each profile are saved here: ~/.aws
You'll use the profile name to run a series of installation scripts. 



### Step 3: Create the Cloud dependencies

Follow the instructions in  tank/installer/ENVIRONMENT_README.md on how to install the Cloud Environment

Come back after your are done with that step.


Update your configuration files with the latest tokens and ids obtained in this step: 
tank/env_config.py
tower/.env.development.*
tower/.env.production.*



### Step 4: Run the Zappa installer

Note: If the Zappa app already exists, put the role IAM in zappa_settings.json instead and skip to Step 5.


Install Zappa
`cd tank`
`pip install zappa`
`pip install setuptools`

Run their init wizard that will walk you through the creation of the environment
`zappa init`

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ZAPPA INIT START

███████╗ █████╗ ██████╗ ██████╗  █████╗
╚══███╔╝██╔══██╗██╔══██╗██╔══██╗██╔══██╗
  ███╔╝ ███████║██████╔╝██████╔╝███████║
 ███╔╝  ██╔══██║██╔═══╝ ██╔═══╝ ██╔══██║
███████╗██║  ██║██║     ██║     ██║  ██║
╚══════╝╚═╝  ╚═╝╚═╝     ╚═╝     ╚═╝  ╚═╝

Welcome to Zappa!

Zappa is a system for running server-less Python web applications on AWS Lambda and AWS API Gateway.
This `init` command will help you create and configure your new Zappa deployment.
Let's get started!

Your Zappa configuration can support multiple production stages, like 'dev', 'staging', and 'production'.
1. What do you want to call this environment (default 'dev'): <environment_name>_<dev|test|prod>

AWS Lambda and API Gateway are only available in certain regions. Let's check to make sure you have a profile set up in one that will work.
2.We found the following profiles: default, and garbanzo. Which would you like us to use? (default 'default'): <aws_profile_from_step_2>


Your Zappa deployments will need to be uploaded to a private S3 bucket.
If you don't have a bucket yet, we'll create one for you too.
3. What do you want to call your bucket? (default 'zappa-7p915w4pa'): <bucket_name_from_step_3>


It looks like this is a Flask application.
What's the modular path to your app's function?
This will likely be something like 'your_module.app'.
We discovered: app.app
4. Where is your app's function? (default 'app.app'): app.app


You can optionally deploy to all available regions in order to provide fast global service.
If you are using Zappa for the first time, you probably don't want to do this!
5. Would you like to deploy this application globally? (default 'n') [y/n/(p)rimary]: n



Okay, here's your zappa_settings.json:
{
    "<environment_name>_<dev|test|prod>": {
        "app_function": "app.app",
        "aws_region": "<aws_region>",
        "exclude": [
            "boto3",
            "dateutil",
            "botocore",
            "s3transfer",
            "concurrent"
        ],
        "profile_name": "<aws_profile_from_step_2>",
        "project_name": "tank",
        "runtime": "python3.12",
        "s3_bucket": "<bucket_name_from_step_3>"
    }
}
6. Does this look okay? (default 'y') [y/n]: y

Done! 

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ZAPPA INIT END

### Step 5: Deploy the Zappa application


First, you need to update the file that has been generated by the zappa init command:  zappa_settings.json
Open it and add the additional configurations (including the role_name)


{
    "<environment_name>_<dev|test|prod>": {
        ...
        "slim_handler": true,
        "domain": "<domain_name>",
        "static_support": true,
        "manage_roles": false,
        "role_name": "<environment_name>_tt_role"
    }
}


One more step before deploying!
If the react application has never been built, you need to do that before deploying Zappa

`cd tower`
`yarn build`


Now run 
`zappa deploy <environment_name>_<dev|test|prod>`


You get something like this:

```
Deploying API Gateway..
Waiting for lambda function [tank-lquant-prod] to be updated...
Deployment complete!: https://<id>.execute-api.<aws_region>.amazonaws.com/<environment_name>_<dev|test|prod>
```


You should be able to test whether the app is running by going to 
`https://<id>.execute-api.<aws_region>.amazonaws.com/<environment_name>_<dev|test|prod>/timex` 
 It should return the server time. 

 You won't be able to access the Application yet, because this url is already using the first position in the path. Tank and Tower depend on the URL for their routing


### Step 6: Setup a customized domain

Setup the API to accept custom domains
- Go to the AWS console > API Gateway and create a new Custom Domain Name

Domain name = <environment_name>.yourdomain.com

- Select a new subdomain under an existing ACM Certificate. 
- If you must use a new domain, you need to create the ACM certificate first (out of the scope of this document)
- Create a  Custom Domain and go to the API mappings. You'll be able to select the API that you just deployed and the stage, save that. 
- This alone won't automatically redirect all traffic to your application. You still need to create a CN Record in your domain.

Configure domain to point to API Gateway

VERY IMPORTANT: The value of the CNRECORD should not be the GATEWAY URL but the CUSTOM DOMAIN URL. They look similar but they are not the same

- To get the right value, go to API Gateway > Custom Domain Names 
- Select the Custom Domain Name and look for "API Gateway domain name" copy and paste it as is
- Create a CN record:

NAME=<environment_name>  VALUE=<domain_name_api_id>.execute-api.<aws_region>.amazonaws.com>

- Save that record and almost immediately you'll be able to see your app in that subdomain. 

TROUBLESHOOT: If you find a blank screen, double check your tank and tower configuration files have the domain you just configured. 





### Step 7: Setting up the Application Email (Optional)

- In order for the App to send emails to users (e.g.invitation emails) you need to create an identity in SES
- An identity is the email that will show as the "from" in the email metadata. Usually it looks like no-reply@<your_domain>.com

- Please notice that if you don't want to send emails out, you can just have your users to generate an account
in the environment directly. Those emails are validated directly by AWS Cognito so you don't need to put them in the
SES identity list. 


